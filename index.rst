:tocdepth: 1

.. sectnum::

.. Metadata such as the title, authors, and description are set in metadata.yaml

.. TODO: Delete the note below before merging new content to the main branch.

.. note::

   **This technote is a work-in-progress.**

Abstract
========

Describes the means of serving the desired DP0.3 data through the services of the Rubin Science Platform.  Initially will serve as a proposal and then evolve into an as-built description.

Motivation and Overview
=======================

Ticket `PREOPS-1152`_ and an in-progress revision of `RTN-011`_ envision the creation of a new entry in the "DP0" (simulated and/or precursor data) series of Data Previews: service of an existing catalog-based "fast simulation" of the expected Solar System data from the LSST survey, not tied to image data and not the output of the main Science Pipelines.

This "DP0.3" would provide some exposure to the Rubin Science Platform (RSP) and the planned Solar System data model to Data Previews delegates, and allow the early testing of certain features of the RSP that are specific to Solar System (or, more precisely, moving-object) data.
As presently discussed, this Data Preview would be made available to users in mid-2023.

The fast simulation, generated by the Solar System Science Collaboration (SSSC), represents the results of the full ten-year baseline LSST survey.
Four catalog tables involved with Solar System science and the Rubin moving-object pipeline would be served as part of DP0.3:
``DIASource``, ``SSSource``, ``SSObject``, and ``MPCORB``.
The first two tables will each have approximately one billion rows each, and the last two will have approximately ten million rows each.

The proposed exercise has some notable limitations compared to the final expected environment for Solar System data:

- As the data are the result of a "fast simulation" without imaging, none of the capabilities of the RSP dealing with imaging data would be exercised.
  For the most part this is not a concern, since DP0.2 has been exercising those capabilities, but there is at least one relevant special case:

  - It is planned to provide for time-series queries on moving objects in the RSP that appear together with appropriate cutouts
    in the images on which the points in the time series were observed.
    This would not be possible in DP0.3.
  - More generally, the usual linkages from single-epoch measurements in catalog tables (in this case, ``DIASource`` and ``SSSource``)
    to the associated images would not be available.

- As the result of a static simulation, rather than a progressive nightly release through the PPDB as we will have in Operations,
  DP0.3 would not exercise certain dynamic aspects of the data model, such as the transformation from DIAObject to SSObject when
  sufficient data are accumulated to allow identification of a previous DIAObject as arising from an SSO.
  It would therefore also not exercise the ability of users of the RSP to follow and/or replay that evolution.


.. _PREOPS-1152: https://jira.lsstcorp.org/browse/PREOPS-1152
.. _RTN-011: https://rtn-011.lsst.io/

Input Data
==========

The simulation itself is described at https://github.com/lsst-sssc/lsst-simulation .
It produces the following tables, all of which have reference definitions in the `DPDD`_:

.. _table-ssotables:

.. table:: Major tables to be included in a Solar System DP0.3

   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+
   | Table     | Purpose                                          | Size in rows | Number of columns | Data volume on disk |
   |           |                                                  |              | (in/not in DPDD)  | (in XXX format)     |
   +===========+==================================================+==============+===================+=====================+
   | DIASource | Observation in a single difference image         |              |                   |                     |
   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+
   | SSSource  | Apparition of a reconstructed SSO in an image    |              |                   |                     |
   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+
   | SSObject  | Reconstructed SSO with orbital parameters        |              |                   |                     |
   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+
   | MPCORB    | Shadow of Minor Planet Center database           |              |                   |                     |
   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+
   | (total)   |                                                  |              |                   | 0.5 - 1.0 TB        |
   +-----------+--------------------------------------------------+--------------+-------------------+---------------------+

The simulation is based on a specific, chosen OpSim run.
The actual simulation output to be used for DP0.3 is yet to be produced, but a prototype dataset exists and has been in use by the SSSC, ingested into a PostgreSQL database.

.. _DPDD: https://lse-163.lsst.io/

Service Model
=============

The RSP instance for DP0.3 would be in the IDF (Google cloud), and, we argue below, could and likely should share most of its components with the existing data.lsst.cloud RSP instance for DP0.2.

Back-end data for DP0.3 as envisioned herein is limited to catalogs.
Therefore no image file store is required, no image metadata service (e.g., ObsTAP), and no DataLink "links service".

The components that *are* required follow:

Catalog Database
----------------

Qserv is probably not a suitable choice for the database back end, for two reasons:

- In the operations-era system, the SSO tables will live in the "Prompt Products Database" (PPDB), which is baselined as PostgreSQL.
- At the moment, Qserv does not have natural support for sharding the SSObject-to-SSSource relationship, which is not spatially localized.

In any event, based on SSSC experience and expert opinion, a single (large) PostgreSQL server should be adequate for the datasets envisioned.
To support spatial searches via (CADC) TAP, the ``pgsphere`` extension should be installed.

In the "Hybrid Model" for the US DAC, the user-facing services will be in the Google cloud, with the data back ends at the USDF.
Replicating this model for DP0.3 would require a large Postgres server at SLAC.
We will analyze the feasibility of this on the relevant time scale.

An alternative would be to configure a Postgres service at the IDF (Google cloud).
Some research will be required to determine whether a sufficiently large Postgres service can be configured easily in the Google cloud.

Data Services
-------------

TAP service
^^^^^^^^^^^

If the database is in Postgres, the CADC TAP service should be used.
The work done in December/January 2022/23 to produce a Postgres-based TAP service for the "live ObsTAP" instances should be applicable.
The same DataLink-support extensions to CADC TAP that are available in the Qserv-backed TAP implementation will be needed for DP0.3 as well.

At present we do not have the ability to support multiple back ends from a single TAP service instance, so DP0.3 will require its own TAP endpoint even  if it is otherwise incorporated into data.lsst.cloud.  For instance, "data.lsst.cloud/api/ssotap" might be a suitable name.

DataLink and ancillary services
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

As noted above, no DataLink "links service" for images is required or even relevant to DP0.3.

User Interface Services
-----------------------

Portal Aspect considerations
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Notebook Aspect considerations
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Authentication and Authorization
--------------------------------


.. A non-Rubin all-sky HiPS image, likely from 2MASS, will be used as the default context image for display of query results in the RSP Portal Aspect.
   This is acceptable for DP0.3 because there is no simulated static sky involved that is significantly different from the real universe
   (Unlike the case for DP0.2).

Preparations Required
=====================

Database Setup
--------------

Ingest
------

On `PREOPS-1152`_, Mario Juric reports that:

"For our internal use, we've used pg_bulkload to rapidly (in ~30 minutes) ingest these tables into a database.
The details are in this (messy) notebook.
Using more typical loading mechanisms (from .csv files, etc.) is not an issue, just will be slower.

"If a postgres database can be set up within the RSP, with pg_bulkload enabled and given administrative permissions I would be able to load these data into it probably in a ~few days.
This setup would also allow for uploads of future dataset updates: we refresh these simulations ~annually, as new baseline simulations become available and the software is improved."

Data Model Metadata
-------------------

Service Deployment
------------------

Potential New Services
^^^^^^^^^^^^^^^^^^^^^^


.. See the `reStructuredText Style Guide <https://developer.lsst.io/restructuredtext/style.html>`__ to learn how to create sections, links, images, tables, equations, and more.

.. Make in-text citations with: :cite:`bibkey`.
.. Uncomment to use citations
.. .. rubric:: References
..
.. .. bibliography:: local.bib lsstbib/books.bib lsstbib/lsst.bib lsstbib/lsst-dm.bib lsstbib/refs.bib lsstbib/refs_ads.bib
..    :style: lsst_aa
